function time(){return(new Date).getTime()}function TIMER(){var a=time(),b=a-TIMER.last;return TIMER.last=a,b}function WARSHIP(){this["super"]();var a=this;window.addEventListener("keydown",function(b){WARSHIP.key[b.keyCode]=!0,90==b.keyCode&&a.fire()}),window.addEventListener("keyup",function(a){WARSHIP.key[a.keyCode]=!1}),window.addEventListener("touchstart",function(a){LAST_TOUCH=a.touches[0].clientX,IS_TAP=!0}),window.addEventListener("touchmove",function(b){IS_TAP=!1;var c=b.touches[0].clientX;a.x+=c-LAST_TOUCH,LAST_TOUCH=c}),window.addEventListener("touchend",function(b){IS_TAP&&a.fire()})}function UFO(a){this["super"](a),this.left=a-this.half,this.right=a+this.half,UFO.list.push(this)}function BULLET(a){this["super"](a),this.left=a-this.half,this.right=a+this.half,BULLET.list.push(this)}function BOOM(a,b){this["super"](a,b),this.ct=time(),BOOM.list.push(this)}function EARTH(){this["super"](),this.count=1}function HP(){this["super"](),this.margin=this.width+5}function init(){canvas=document.getElementById("stage"),canvas.width=STAGE_WIDTH,canvas.height=STAGE_HEIGHT,ctx=canvas.getContext("2d"),buffer=document.createElement("canvas"),buffer.width=STAGE_WIDTH,buffer.height=STAGE_HEIGHT,stage=buffer.getContext("2d"),game=document.getElementById("game"),score=document.getElementById("score"),earth=new EARTH,warship=new WARSHIP,hp=new HP,document.getElementById("loading").remove(),start()}function start(){GAME_OVER=!1,GAME_SCORE=0,warship.init(),UFO.init(),hp.init(),TIMER(),loop(),game.classList.add("active")}function end(){GAME_OVER=!0,UFO.clear(),BULLET.clear(),BOOM.clear(),score.textContent=GAME_SCORE,game.classList.remove("active")}function loop(){if(!GAME_OVER){ctx.clearRect(0,0,STAGE_WIDTH,STAGE_HEIGHT),stage.clearRect(0,0,STAGE_WIDTH,STAGE_HEIGHT);var a,b=TIMER();for(a=0;a<UFO.list.length;a++)UFO.list[a].loop(b);for(a=0;a<BULLET.list.length;a++)BULLET.list[a].loop();for(a=0;a<BOOM.list.length;a++)BOOM.list[a].loop();earth.loop(),hp.loop(),warship.loop(),ctx.drawImage(buffer,0,0),requestAnimationFrame(loop)}}GAME_OVER=!0,GAME_SCORE=0,Array.prototype.remove=function(a){var b=this.indexOf(a);return-1==b?!1:(this.splice(b,1),this)},"undefined"==typeof Element.prototype.remove&&(Element.prototype.remove=function(){this.parentNode.removeChild(this)}),Object.prototype["super"]=function(a,b){var c=this.constructor;this.x=a?a:c.x,this.y=b?b:c.y,this.speed=c.speed,this.image=document.getElementById(c.image),this.width=this.image.width,this.height=this.image.height,this.half=this.width/2},TIMER.last=0,WARSHIP.prototype.loop=function(){WARSHIP.key[37]&&(this.x-=WARSHIP.speed,this.x=this.x>0?this.x:0),WARSHIP.key[39]&&(this.x+=WARSHIP.speed,this.x=this.x<STAGE_WIDTH?this.x:STAGE_WIDTH),stage.drawImage(this.image,this.x-this.half,this.y)},WARSHIP.prototype.fire=function(){new BULLET(this.x)},WARSHIP.prototype.init=function(){this.x=WARSHIP.x},WARSHIP.x=240,WARSHIP.y=395,WARSHIP.image="warship",WARSHIP.key={37:!1,39:!1,90:!1},UFO.prototype.loop=function(a){this.y+=UFO.speed*a/1e3,this.y<STAGE_HEIGHT-120?stage.drawImage(this.image,this.left,this.y):(this.destroy(),earth.hit())},UFO.prototype.hit=function(){GAME_SCORE++,this.destroy()},UFO.prototype.destroy=function(){UFO.list.remove(this),delete this},UFO.y=-80,UFO.image="ufo",UFO.list=[],UFO.n=null,UFO.g=function(){Math.random()>UFO.rate||new UFO(Math.floor(Math.random()*(STAGE_WIDTH-100))+30)},UFO.init=function(){UFO.n=setInterval(UFO.g,UFO.cd)},UFO.clear=function(){clearInterval(UFO.n),UFO.list=[]},BULLET.prototype.loop=function(){this.y-=BULLET.speed,stage.drawImage(this.image,this.left,this.y),this.y<-this.height&&this.destroy();for(var a=0;a<UFO.list.length;a++){var b=UFO.list[a];this.x>b.left&&this.x<b.right&&this.y<b.y+b.height&&(b.hit(),new BOOM(this.x,this.y))}},BULLET.prototype.destroy=function(){BULLET.list.shift(),delete this},BULLET.y=WARSHIP.y,BULLET.image="bullet",BULLET.list=[],BULLET.clear=function(){BULLET.list=[]},BOOM.prototype.loop=function(){var a=time()-this.ct;return a>BOOM.lasts?void this.destroy():(stage.save(),stage.globalAlpha=1-a/BOOM.lasts,stage.drawImage(this.image,this.x-this.half,this.y-this.half),void stage.restore())},BOOM.prototype.destroy=function(){BOOM.list.remove(this),delete this},BOOM.clear=function(){BOOM.list=[]},BOOM.image="boom",BOOM.list=[],EARTH.prototype.hit=function(){var a=this;hp.decr(),this.count&&clearInterval(this.ticker),this.count=1,this.flag=!0,this.ticker=setInterval(function(){a.count>4&&clearInterval(a.ticker),a.flag=a.flag?!1:!0,a.count++},200)},EARTH.prototype.loop=function(){this.flag?stage.drawImage(this.image,this.x,this.height/2,this.width,this.height/2,this.x,this.y,this.width,this.height/2):stage.drawImage(this.image,this.x,0,this.width,this.height/2,this.x,this.y,this.width,this.height/2)},EARTH.x=0,EARTH.y=420,EARTH.image="earth",EARTH.tick=null,HP.prototype.init=function(){this.hp=HP.total},HP.prototype.decr=function(){this.hp--,0==this.hp&&end()},HP.prototype.loop=function(){for(var a=0;a<HP.total-1;a++)a<this.hp-1?stage.drawImage(this.image,0,0,this.width,this.height/2,this.x+a*this.margin,this.y,this.width,this.height/2):stage.drawImage(this.image,0,this.height/2,this.width,this.height/2,this.x+a*this.margin,this.y,this.width,this.height/2)},HP.x=20,HP.y=20,HP.image="life",window.onload=init,HP.total=4,WARSHIP.speed=8,UFO.speed=100,UFO.cd=1e3,UFO.rate=.6,BULLET.speed=4,BOOM.lasts=1e3,STAGE_WIDTH=465,STAGE_HEIGHT=465;